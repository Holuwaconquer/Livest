<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      input{
        cursor: not-allowed;
      }
    </style>
  </head>
<body>
    <div class="shadow rounded p-5 mx-4 bg-white">
        <h4 class="mb-5">Personal Details</h4>
        <form class="row g-3">
            <div class="mb-3 d-flex gap-3 align-items-center">
                <img id="imagePreview" style="width: 70px; height: 70px; border-radius: 50%; object-fit: cover; border: 1px solid darkblue; display: none;">
                <input style="display: none;" type="file" id="fileInput" accept="image/*" />
              </div>
            <div class="col-md-3">
              <label for="inputEmail4" class="form-label">Surname</label>
              <input disabled type="text" class="form-control" id="surname">
            </div>
            <div class="col-md-3">
              <label for="inputPassword4" class="form-label">Firstname</label>
              <input disabled type="text" class="form-control" id="firstname">
            </div>
            <div class="col-md-3">
              <label for="inputPassword4" class="form-label">Middlename</label>
              <input disabled type="text" class="form-control" id="middlename">
            </div>
            <div class="col-md-3">
                <label for="inputState" class="form-label">Gender</label>
                <select disabled id="gender" class="form-select">
                  <option selected>Choose...</option>
                  <option value="male">Male</option>
                  <option value="female">Female</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="inputState" class="form-label">Marital Status</label>
                <select disabled id="maritalStatus" class="form-select">
                  <option selected>Choose...</option>
                  <option value="single">Single</option>
                  <option value="married">Married</option>
                  <option value="divorced">Divorced</option>
                  <option value="widow">Widow/widower</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="inputPassword4" class="form-label">Date of birth</label>
                <input disabled type="date" class="form-control" id="dob">
            </div>
            <div class="col-md-3">
                <label for="inputState" class="form-label">Country</label>
                <select disabled id="country" class="form-select">
                  <option selected>Choose...</option>
                  <option value="">-- Select a country --</option>
                    <option value="Afghanistan">Afghanistan</option>
                    <option value="Albania">Albania</option>
                    <option value="Algeria">Algeria</option>
                    <option value="Andorra">Andorra</option>
                    <option value="Angola">Angola</option>
                    <option value="Antigua and Barbuda">Antigua and Barbuda</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Armenia">Armenia</option>
                    <option value="Australia">Australia</option>
                    <option value="Austria">Austria</option>
                    <option value="Azerbaijan">Azerbaijan</option>
                    <option value="Bahamas">Bahamas</option>
                    <option value="Bahrain">Bahrain</option>
                    <option value="Bangladesh">Bangladesh</option>
                    <option value="Barbados">Barbados</option>
                    <option value="Belarus">Belarus</option>
                    <option value="Belgium">Belgium</option>
                    <option value="Belize">Belize</option>
                    <option value="Benin">Benin</option>
                    <option value="Bhutan">Bhutan</option>
                    <option value="Bolivia">Bolivia</option>
                    <option value="Bosnia and Herzegovina">Bosnia and Herzegovina</option>
                    <option value="Botswana">Botswana</option>
                    <option value="Brazil">Brazil</option>
                    <option value="Brunei">Brunei</option>
                    <option value="Bulgaria">Bulgaria</option>
                    <option value="Burkina Faso">Burkina Faso</option>
                    <option value="Burundi">Burundi</option>
                    <option value="Cabo Verde">Cabo Verde</option>
                    <option value="Cambodia">Cambodia</option>
                    <option value="Cameroon">Cameroon</option>
                    <option value="Canada">Canada</option>
                    <option value="Central African Republic">Central African Republic</option>
                    <option value="Chad">Chad</option>
                    <option value="Chile">Chile</option>
                    <option value="China">China</option>
                    <option value="Colombia">Colombia</option>
                    <option value="Comoros">Comoros</option>
                    <option value="Congo (Congo-Brazzaville)">Congo (Congo-Brazzaville)</option>
                    <option value="Costa Rica">Costa Rica</option>
                    <option value="Croatia">Croatia</option>
                    <option value="Cuba">Cuba</option>
                    <option value="Cyprus">Cyprus</option>
                    <option value="Czech Republic">Czech Republic</option>
                    <option value="Democratic Republic of the Congo">Democratic Republic of the Congo</option>
                    <option value="Denmark">Denmark</option>
                    <option value="Djibouti">Djibouti</option>
                    <option value="Dominica">Dominica</option>
                    <option value="Dominican Republic">Dominican Republic</option>
                    <option value="Ecuador">Ecuador</option>
                    <option value="Egypt">Egypt</option>
                    <option value="El Salvador">El Salvador</option>
                    <option value="Equatorial Guinea">Equatorial Guinea</option>
                    <option value="Eritrea">Eritrea</option>
                    <option value="Estonia">Estonia</option>
                    <option value="Eswatini">Eswatini</option>
                    <option value="Ethiopia">Ethiopia</option>
                    <option value="Fiji">Fiji</option>
                    <option value="Finland">Finland</option>
                    <option value="France">France</option>
                    <option value="Gabon">Gabon</option>
                    <option value="Gambia">Gambia</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Germany">Germany</option>
                    <option value="Ghana">Ghana</option>
                    <option value="Greece">Greece</option>
                    <option value="Grenada">Grenada</option>
                    <option value="Guatemala">Guatemala</option>
                    <option value="Guinea">Guinea</option>
                    <option value="Guinea-Bissau">Guinea-Bissau</option>
                    <option value="Guyana">Guyana</option>
                    <option value="Haiti">Haiti</option>
                    <option value="Honduras">Honduras</option>
                    <option value="Hungary">Hungary</option>
                    <option value="Iceland">Iceland</option>
                    <option value="India">India</option>
                    <option value="Indonesia">Indonesia</option>
                    <option value="Iran">Iran</option>
                    <option value="Iraq">Iraq</option>
                    <option value="Ireland">Ireland</option>
                    <option value="Israel">Israel</option>
                    <option value="Italy">Italy</option>
                    <option value="Ivory Coast">Ivory Coast</option>
                    <option value="Jamaica">Jamaica</option>
                    <option value="Japan">Japan</option>
                    <option value="Jordan">Jordan</option>
                    <option value="Kazakhstan">Kazakhstan</option>
                    <option value="Kenya">Kenya</option>
                    <option value="Kiribati">Kiribati</option>
                    <option value="Kuwait">Kuwait</option>
                    <option value="Kyrgyzstan">Kyrgyzstan</option>
                    <option value="Laos">Laos</option>
                    <option value="Latvia">Latvia</option>
                    <option value="Lebanon">Lebanon</option>
                    <option value="Lesotho">Lesotho</option>
                    <option value="Liberia">Liberia</option>
                    <option value="Libya">Libya</option>
                    <option value="Liechtenstein">Liechtenstein</option>
                    <option value="Lithuania">Lithuania</option>
                    <option value="Luxembourg">Luxembourg</option>
                    <option value="Madagascar">Madagascar</option>
                    <option value="Malawi">Malawi</option>
                    <option value="Malaysia">Malaysia</option>
                    <option value="Maldives">Maldives</option>
                    <option value="Mali">Mali</option>
                    <option value="Malta">Malta</option>
                    <option value="Marshall Islands">Marshall Islands</option>
                    <option value="Mauritania">Mauritania</option>
                    <option value="Mauritius">Mauritius</option>
                    <option value="Mexico">Mexico</option>
                    <option value="Micronesia">Micronesia</option>
                    <option value="Moldova">Moldova</option>
                    <option value="Monaco">Monaco</option>
                    <option value="Mongolia">Mongolia</option>
                    <option value="Montenegro">Montenegro</option>
                    <option value="Morocco">Morocco</option>
                    <option value="Mozambique">Mozambique</option>
                    <option value="Myanmar">Myanmar</option>
                    <option value="Namibia">Namibia</option>
                    <option value="Nauru">Nauru</option>
                    <option value="Nepal">Nepal</option>
                    <option value="Netherlands">Netherlands</option>
                    <option value="New Zealand">New Zealand</option>
                    <option value="Nicaragua">Nicaragua</option>
                    <option value="Niger">Niger</option>
                    <option value="Nigeria">Nigeria</option>
                    <option value="North Korea">North Korea</option>
                    <option value="North Macedonia">North Macedonia</option>
                    <option value="Norway">Norway</option>
                    <option value="Oman">Oman</option>
                    <option value="Pakistan">Pakistan</option>
                    <option value="Palau">Palau</option>
                    <option value="Palestine State">Palestine State</option>
                    <option value="Panama">Panama</option>
                    <option value="Papua New Guinea">Papua New Guinea</option>
                    <option value="Paraguay">Paraguay</option>
                    <option value="Peru">Peru</option>
                    <option value="Philippines">Philippines</option>
                    <option value="Poland">Poland</option>
                    <option value="Portugal">Portugal</option>
                    <option value="Qatar">Qatar</option>
                    <option value="Romania">Romania</option>
                    <option value="Russia">Russia</option>
                    <option value="Rwanda">Rwanda</option>
                    <option value="Saint Kitts and Nevis">Saint Kitts and Nevis</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="inputState" class="form-label">State of Origin</label>
                <select disabled id="stateOrigin" class="form-select">
                  <option selected>Choose...</option>
                </select>
            </div>
            <h6 class="mt-5">Contact</h6>
            <div class="col-md-3">
              <label for="inputAddress" class="form-label">Phone Number</label>
              <input disabled type="text" class="form-control" id="phoneNumber">
            </div>
            <div class="col-md-3">
              <label for="inputAddress" class="form-label">Phone Number 2</label>
              <input disabled type="text" class="form-control" id="phoneNumber2">
            </div>
            <div class="col-6">
              <label for="inputAddress2" class="form-label">Email</label>
              <input disabled type="email" class="form-control" id="email">
            </div>
            <div class="col-12">
              <label for="inputAddress2" class="form-label">Address</label>
              <input disabled type="text" class="form-control" id="houseAddress" placeholder="Apartment, studio, or floor">
            </div>
            <h6 class="mt-5">Business Information</h6>
            <div class="col-md-3">
              <label for="inputCity" class="form-label">Business name</label>
              <input disabled type="text" class="form-control" id="businessName">
            </div>
            
            <div class="col-md-3">
              <label for="inputZip" class="form-label">Phone Number</label>
              <input disabled type="text" class="form-control" id="businessNumber">
            </div>
            <div class="col-md-6">
              <label for="inputZip" class="form-label">Email</label>
              <input disabled type="text" class="form-control" id="businessEmail">
            </div>
            <div class="col-12">
              <button id="editInfo" type="button" class="btn btn-primary">Edit</button>
              <button id="saveInfo" style="display: none;" type="button" class="btn btn-primary">Save</button>
            </div>
          </form>
    </div>



  <script type="module">
  import Swal from 'https://cdn.skypack.dev/sweetalert2';
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-auth.js";
  import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.5.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyASp595xhwD3gYSm_CfzivBe5hE0MtnA_o",
    authDomain: "livest-real-estate.firebaseapp.com",
    databaseURL: "https://livest-real-estate-default-rtdb.firebaseio.com",
    projectId: "livest-real-estate",
    storageBucket: "livest-real-estate.firebasestorage.app",
    messagingSenderId: "647434805745",
    appId: "1:647434805745:web:610c262a9968a1a6ac2450"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const database = getDatabase(app);

  // Form elements
  const surname = document.getElementById('surname');
  const firstname = document.getElementById('firstname');
  const middlename = document.getElementById('middlename');
  const email = document.getElementById('email');
  const dob = document.getElementById('dob');
  const gender = document.getElementById('gender');
  const maritalStatus = document.getElementById('maritalStatus');
  const country = document.getElementById('country');
  const stateOrigin = document.getElementById('stateOrigin');
  const houseAddress = document.getElementById('houseAddress');
  const businessName = document.getElementById('businessName');
  const businessEmail = document.getElementById('businessEmail');
  const businessNumber = document.getElementById('businessNumber');
  const phoneNumber = document.getElementById('phoneNumber');
  const phoneNumber2 = document.getElementById('phoneNumber2');
  const saveInfo = document.getElementById('saveInfo');
  const editInfo = document.getElementById('editInfo');
  const fileInput = document.getElementById("fileInput");
  const preview = document.getElementById("imagePreview");

  const cloudName = "dimlar6iu";
  const uploadPreset = "Livest";

  let selectedImageUrl = "";

  onAuthStateChanged(auth, (user) => {
    if (!user) return;

    const userRef = ref(database, 'users/' + user.uid);
    
    // If user.displayName is set, split it into first and last names
    if (user.displayName) {
      const nameParts = user.displayName.split(' ');
      const first = nameParts[0] || '';
      const last = nameParts.slice(1).join(' ') || '';

    }
    email.value = user.email || "";

    // Image upload handler
    fileInput.addEventListener("change", async (event) => {
      const file = event.target.files[0];
      if (!file) return;

      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";

      // Disable save while uploading
      saveInfo.disabled = true;
      saveInfo.textContent = "Uploading...";

      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      try {
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: "POST",
          body: formData
        });
        const data = await response.json();
        console.log("Cloudinary response:", data);

        selectedImageUrl = data.secure_url;
        console.log("Selected Image URL:", selectedImageUrl);

        // Enable save button now that upload is done
        saveInfo.disabled = false;
        saveInfo.textContent = "Save";
      } catch (error) {
        console.error("Cloudinary upload error:", error);
        Swal.fire({
          icon: 'error',
          title: 'Image Upload Failed',
          text: 'Could not upload image. Try again.',
        });
        saveInfo.disabled = false;
        saveInfo.textContent = "Save";
      }
    });


    // Edit button click
    editInfo.addEventListener('click', () => {
      editInfo.style.display = "none";
      saveInfo.style.display = "block";

      [
        surname, firstname, middlename, email, dob, gender, maritalStatus,
        country, stateOrigin, houseAddress, businessName, businessEmail,
        businessNumber, phoneNumber, phoneNumber2
      ].forEach(input => {
        input.disabled = false;
        input.style.cursor = "default";
      });

      fileInput.style.display = "block";
    });

    // Save button click
    saveInfo.addEventListener('click', async () => {
        // Only trigger save if file is already uploaded or no file selected
        if (fileInput.files.length && !selectedImageUrl) {
          return Swal.fire({
            icon: 'warning',
            title: 'Wait!',
            text: 'Please wait for image to finish uploading.',
          });
        }

        const userProfile = {
          surname: surname.value,
          firstname: firstname.value,
          middlename: middlename.value,
          email: email.value,
          dob: dob.value,
          gender: gender.value,
          maritalStatus: maritalStatus.value,
          country: country.value,
          stateOrigin: stateOrigin.value,
          houseAddress: houseAddress.value,
          businessName: businessName.value,
          businessEmail: businessEmail.value,
          businessNumber: businessNumber.value,
          phoneNumber: phoneNumber.value,
          phoneNumber2: phoneNumber2.value,
          profilePicture: selectedImageUrl || preview.src
        };

        console.log("Saving user profile:", userProfile);

        console.log("Final profilePicture value:", selectedImageUrl);
        set(userRef, userProfile)
          .then(() => {
            Swal.fire({
              icon: 'success',
              title: 'Success',
              text: 'Information saved successfully!',
              timer: 2000,
              showConfirmButton: false
            });

            editInfo.style.display = "block";
            saveInfo.style.display = "none";

            [
              surname, firstname, middlename, email, dob, gender, maritalStatus,
              country, stateOrigin, houseAddress, businessName, businessEmail,
              businessNumber, phoneNumber, phoneNumber2
            ].forEach(input => {
              input.disabled = true;
              input.style.cursor = "not-allowed";
            });

            fileInput.style.display = "none";
          })
          .catch((error) => {
            console.error("Error saving user info:", error);
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'Failed to save information.',
            });
          });
      });


    // Load existing data from Firebase if available
    onValue(userRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      surname.value = data.surname || "";
      firstname.value = data.firstname || "";
      middlename.value = data.middlename || "";
      email.value = data.email || "";
      dob.value = data.dob || "";
      gender.value = data.gender || "";
      maritalStatus.value = data.maritalStatus || "";
      country.value = data.country || "";
      stateOrigin.value = data.stateOrigin || "";
      houseAddress.value = data.houseAddress || "";
      businessName.value = data.businessName || "";
      businessEmail.value = data.businessEmail || "";
      businessNumber.value = data.businessNumber || "";
      phoneNumber.value = data.phoneNumber || "";
      phoneNumber2.value = data.phoneNumber2 || "";

      if (data.profilePicture) {
        preview.src = data.profilePicture;
        preview.style.display = "block";
      }
    });
  });
</script>


</body>
</html>